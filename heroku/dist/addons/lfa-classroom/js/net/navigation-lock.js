define(["backbone","./net","app"],function(Backbone,Net,App){function NavigationLock(){this.navLocked=!1,this.teacherNavigationLocked="true"===App.storage.getItem("teacherNavigationLocked"),App.on("classroom:registerClients",this.registerClients.bind(this)),App.on("classroom:unregisterClients",this.unregisterClients.bind(this)),App.on("classroom:disconnected",this.onDisconnect.bind(this)),App.on("classroom:recv:navigation",this.onRemoteNavigation.bind(this)),App.on("classroom:navigation:scroll",this.sendTeacherScroll.bind(this)),App.on("classroom:navigation:scrollTo",this.scrollInPage.bind(this)),App.on("classroom:navigation:setLock",this.teacherSetNavigationLocked.bind(this)),App.book.on("render",this.uriChanged.bind(this))}var net=Net.singleton();return NavigationLock.singleton=function(){return window.NavigationLockSingletonInstance||(window.NavigationLockSingletonInstance=new NavigationLock),window.NavigationLockSingletonInstance},NavigationLock.prototype.teacherGetNavigationLocked=function(){return this.teacherNavigationLocked},NavigationLock.prototype.sendTeacherNavLock=function(to,scroll){App.trigger("classroom:send",{action:"navigation",lockState:this.teacherNavigationLocked,lockUri:this.currentUri(),to:to,scroll:scroll})},NavigationLock.prototype.registerClients=function(clients){var self=this;net.isTeacher()&&_.each(clients,function(client){self.sendTeacherNavLock(client.id,self.currentScroll())})},NavigationLock.prototype.unregisterClients=function(clients){var teacherId=net.getClassroom().teacher,self=this;_.each(clients,function(client){client.id===teacherId&&self.onDisconnect()})},NavigationLock.prototype.onDisconnect=function(){this.setNavigationLocked(!1,null,function(){})},NavigationLock.prototype.sendTeacherScroll=function(scroll){net.isTeacher()&&(void 0===scroll&&(scroll=this.currentScroll()),this.sendTeacherNavLock(null,scroll))},NavigationLock.prototype.onRemoteNavigation=function(msg){if(msg.from.id===net.getClassroom().teacher){var self=this;self.setNavigationLocked(msg.lockState,msg.lockUri,function(){void 0!==msg.scroll&&(msg.lockUri?self.jumpAndScroll(msg.lockUri,msg.scroll):self.scrollInPage(msg.scroll))})}},NavigationLock.prototype.teacherSetNavigationLocked=function(val){val!==this.teacherNavigationLocked&&(this.teacherNavigationLocked=val,App.storage.setItem("teacherNavigationLocked",val),App.trigger("classroom:navigation:navLock:changed",val),net.isTeacher()&&this.sendTeacherNavLock())},NavigationLock.prototype.uriChanged=function(obj){this._currentUri=obj.chapter,net.isTeacher()&&this.teacherGetNavigationLocked()&&this.sendTeacherNavLock()},NavigationLock.prototype.currentUri=function(){return this._currentUri},NavigationLock.prototype.currentScroll=function(){var sv=$("#scrollview"),svh=sv.height(),s=sv.scrollTop(),h=sv.children("section").outerHeight();if(svh>h)return 0;var r=s/(h-svh);return isFinite(r)||(r=0),0>r&&(r=0),r>1&&(r=1),r},NavigationLock.prototype.jumpToPage=function(uri,cb){function changeUri(uri){window.location.replace?window.location.replace(uri):window.location.href=uri}return this.currentUri()===uri?void cb():(changeUri("/#/book/"+uri),void setTimeout(cb,500))},NavigationLock.prototype.setNavigationLocked=function(val,uri,cb){"function"==typeof uri&&(cb=uri,uri=this.currentUri()),this.navLocked!==val&&(this.navLocked=val,val?($("html").addClass("navigation-locked"),App.book.closeSidebars()):$("html").removeClass("navigation-locked")),val?this.jumpToPage(uri,cb):cb()},NavigationLock.prototype.jumpAndScroll=function(uri,scroll){var self=this;self.jumpToPage(uri,function(){self.scrollInPage(scroll)})},NavigationLock.prototype.scrollInPage=function(scroll){function easing(x){return 1-(1-x)*(1-x)}function step(){var time=Date.now();startTime||(startTime=time);var pos=(time-startTime)/duration;pos>=1&&(pos=1,cancelAnimation()),sv.scrollTop(start+(target-start)*easing(pos)),running&&window.requestAnimationFrame(step)}function cancelAnimation(){running=!1,sv.off(cancelEvents,cancelAnimation)}var sv=$("#scrollview"),svh=sv.height(),h=sv.children("section").outerHeight();if(!(svh>h)){var target=scroll*(h-svh),start=sv.scrollTop(),startTime=null,duration=500,running=!0;if(start!==target){var cancelEvents="touchdown mousewheel keyup pointerdown MSPointerDown";sv.on(cancelEvents,cancelAnimation),window.requestAnimationFrame(step)}}},NavigationLock});