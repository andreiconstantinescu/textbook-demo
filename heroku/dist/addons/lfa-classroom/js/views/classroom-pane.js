define(["backbone","../net/net","../net/navigation-lock","app","./classmate-list","./name-input","./nearby-classrooms","./teacher-control-panel","./alert-sound","../translations"],function(Backbone,Net,NavLock,App,ClassmateList,NameInput,NearbyClassrooms,TeacherControlPanel,alertUri,T){var net=Net.singleton(),ClassroomPane=(NavLock.singleton(),Backbone.View.extend({initialize:function(opts){function setAway(val){App.trigger("classroom:setAway",val)}if(opts=opts||{},this.$tabEl=opts.tabEl,this.renderTab(),this.render(),this.awayStatus=!1,this.autoconnect="true"===App.storage.getItem("classroomAutoconnect"),this.setGroup(this.getGroup()),this.listenTo(App,"classroom:connectionStateChanged",this.connectionStateChanged.bind(this)),this.listenTo(App,"classroom:setAway",this.setAwayStatus.bind(this)),this.listenTo(App,"classroom:registerClients",this.registerClients.bind(this)),this.listenTo(App,"classroom:alert",this.ringAlert.bind(this)),this.listenTo(App,"classroom:alert:send",this.sendAlert.bind(this)),this.listenTo(App,"classroom:recv:alert",this.recieveAlert.bind(this)),this.listenTo(App,"classroom:join",this.joinClassroom.bind(this)),this.listenTo(App.book,"sidebar:open",function(sidebar){"rightbar-active"===sidebar&&net.startLocationLookup()}),this.listenTo(App,"classroom:navigation:navLock:changed",function(val){App.trigger("notify","You have "+(val?"locked":"unlocked")+" navigation",{persistent:!1})}),this.listenTo(App,"classroom:navigation:scroll",function(){App.trigger("notify","You brought everybody here",{persistent:!1})}),$(window).on("blur",setAway.bind(this,!0)),$(window).on("focus",setAway.bind(this,!1)),this.autoconnect){var code=App.storage.getItem("classroomCode");this.joinClassroom(code)}},tabTemplate:function(){return window.getMixin("classroom-pane-tab")()},renderTab:function(){this.$tabEl.html(this.tabTemplate())},connectionStateChanged:function(){this.autoconnect="connected"===net.getConnectionState(),App.storage.setItem("classroomAutoconnect",this.autoconnect),this.render()},render:function(){var state=net.getConnectionState();switch(this.destroyRendered(),state){case"disconnected":this.renderDisconnected();break;case"connecting":this.renderConnecting();break;case"connected":this.renderConnected()}var html=$("html");html.toggleClass("classroom-teacher",net.isTeacher()),html.toggleClass("classroom-connected","connected"===state),html.toggleClass("classroom-disconnected","disconnected"===state),html.toggleClass("classroom-connecting","connecting"===state),T.translateElement(this.$el)},destroyRendered:function(){this.classmateList&&(this.classmateList.remove(),this.classmateList=null),this.nearbyList&&(this.nearbyList.remove(),this.nearbyList=null),this.controlPanel&&(this.controlPanel.remove(),this.controlPanel=null),this.nameInput&&(this.nameInput.remove(),this.nameInput=null)},renderDisconnected:function(){function joinClassroom(){self.joinClassroom(joinTextbox.val())}var self=this;self.$el.html(window.getMixin("classroom-pane-disconnected")());var joinTextbox=self.$("#classroom-join-code");joinTextbox.keydown(function(event){13===(event.keyCode||event.which)&&joinClassroom()});var oldCode=App.storage.getItem("classroomCode");oldCode&&joinTextbox.val(oldCode),this.nearbyList=new NearbyClassrooms({el:self.$(".nearby")}),self.$(".backstage-button#classroom-join").click(joinClassroom),self.$(".backstage-button#classroom-create").click(this.makeClassroom.bind(this))},renderConnecting:function(){var self=this;self.$el.html(window.getMixin("classroom-pane-connecting")()),self.$(".backstage-button#classroom-disconnect").click(function(){net.disconnect()})},getGroup:function(){if("undefined"==typeof App.workGroup){var r=parseInt(App.storage.getItem("workGroup"));return isNaN(r)&&(r=null),r}return App.workGroup},setGroup:function(group){App.workGroup=group,App.storage.setItem("workGroup",group),net.setCookie("group",group)},renderGroupSelector:function(){var tabs=this.$(".group-tabs"),currentGroup=(this.getGroup()||0).toString();tabs.find("li").each(function(idx,el){var $el=$(el),group=$el.data("group").toString();$el.toggleClass("active",group===currentGroup)})},renderConnected:function(){var self=this;self.$el.html(window.getMixin("classroom-pane-connected")({classroom:net.getClassroom()})),self.$(".backstage-button#classroom-disconnect").click(function(){net.disconnect()}),self.$(".classroom-info, #classroom-fullscreen").click(this.showClassroomInfo.bind(this)),self.renderGroupSelector();var tabs=this.$(".group-tabs");tabs.find("li").each(function(idx,el){var $el=$(el),group=parseInt($el.data("group"));(!group||isNaN(group))&&(group=null),$el.find("a").click(function(){var old=self.getGroup();old!==group&&(self.setGroup(group),self.renderGroupSelector())})}),net.isTeacher()&&(self.controlPanel=new TeacherControlPanel,$(".navigation-menu").append(self.controlPanel.$el)),self.nameInput=new NameInput({el:self.$(".name-input")}),self.classmateList=new ClassmateList({el:self.$(".classroom-clients")})},showClassroomInfo:function(){var info=$(window.getMixin("classroom-fullscreen-info")({classroom:net.getClassroom()}));$("html").append(info),info.on("click",function(){info.remove()})},recieveAlert:function(msg){msg.from.id===net.getClassroom().teacher&&this.ringAlert()},sendAlert:function(id){net.isTeacher()&&App.trigger("classroom:send",{to:id,action:"alert"})},ringAlert:function(){var audio=new window.Audio(alertUri);audio.play();var pane=$('<div id="classroom-alert-panel"></div>');$("body").append(pane),pane.one("webkitAnimationEnd oanimationend msAnimationEnd animationend",function(){pane.remove()})},setAwayStatus:function(val){this.awayStatus=val,App.trigger("classroom:broadcast",{action:"setAway",state:this.awayStatus})},registerClients:function(clients){var self=this;_.each(clients,function(client){App.trigger("classroom:send",{to:client.id,action:"setAway",state:self.awayStatus})})},handleError:function(string,err){if(console.error(string,err),!err.abort){var errorText=string+err.message;alert(errorText)}},joinClassroom:function(code){var self=this;code&&net.joinClassroom(code,function(err,data){err?self.handleError("Can't join classroom "+code+": ",err):(App.storage.setItem("classroomCode",code),console.log("Joined classroom: ",code,data))})},makeClassroom:function(){var self=this;net.createClassroom(function(err,data){err?self.handleError("Can't create a classroom: ",err):(App.storage.setItem("classroomCode",data.address),console.log("Joined classroom: ",data))})}}));return ClassroomPane.order=5,ClassroomPane.activePriority=20,ClassroomPane.paneName="classroom",window.backstagePanes=window.backstagePanes||[],window.backstagePanes.push(ClassroomPane),ClassroomPane});