define(["app","../js/exercise","../lib/Sortable"],function(App,Exercises,Sortable){var DragAndSort=Exercises.Exercise.extend({type:"DragAndSort",defaultIrritationLevel:25,onUpdate:function(){var self=this,newOrder=[];self.$el.find(".item").each(function(index,el){var $el=$(el);newOrder.push($el.data("index")),$el.removeClass("item-in-place item-not-in-place").addClass($el.data("target")===index?"item-in-place":"item-not-in-place")}),self.set("state",newOrder),self.trigger("change:state",newOrder,self)},componentDidMount:function(){var self=this,items=self.$el.find(".item"),l=items.length;self.container=self.$el.find(".items")[0]||self.$el[0],self.sortable=new Sortable(self.container,{group:self.options.group||"group"+self.id,handle:self.options.handle,draggable:self.options.draggable||".item",onUpdate:function(){self.onUpdate()}}),self.on("change:state",function(){self.changingRemotely||App.trigger("classroom:broadcast",{action:"ex_"+self.id+":change",state:self.get("state")})}),self.rearrange(),self.irritationLevel=self.options.irritationLevel||Math.round(l*l/1.2)},onRemoteChanges:function(msg){{var self=this;self.get("state")}self.changingRemotely=!0,self.set("state",msg.state);var newValue="",notification=App.T.translate("dragAndSortNoDescription",[msg.from.name||msg.from.id,newValue]);App.trigger("notify",notification),self.rearrange(),self.onUpdate(),self.changingRemotely=!1},rearrange:function(){var i,self=this,items=self.$el.find(".item"),l=items.length,dataIndeces=[];for(i=0;l>i;i++)dataIndeces.push($(items[i]).data("index"));for(dataIndeces.sort(),i=0;l>i;i++)$(items[i]).data("target",_.indexOf(dataIndeces,$(items[i]).data("index")));var state=self.get("state")||[];if(0!==state.length){var currentOrder=new Array(l);for(items.detach(),i=0;l>i;i++)currentOrder[$(items[i]).data("index")]=i;for(i=0;l>i;i++)$(this.container).append(items[currentOrder[state[i]]]),$(items[i]).data("target",_.indexOf(dataIndeces,$(items[i]).data("index")))}},componentWillUnmount:function(){this.sortable&&this.sortable.destroy()},scoreComputedByInPlace:function(){var self=this,$items=self.$el.find(".item")||1,$itemsInPlace=self.$el.find(".item-in-place");return Math.round(100*$itemsInPlace.length/$items.length)},scoreComputedByRelativeOrder:function(){for(var self=this,state=self.get("state")||[],score=0,i=1,l=state.length;l>i;i++)state[i-1]<=state[i]&&score++;return score=Math.round(100*score/(l-1))},score:function(){var self=this,s=self.options.scoreByRelativeOrder?this.scoreComputedByRelativeOrder():this.scoreComputedByInPlace();return self.trigger("change:score",s,self),s>=100?self.$el.addClass("done"):self.$el.removeClass("done"),s}});return Exercises.DragAndSort=DragAndSort,Exercises});