define(["jquery","backbone","../js/exercise"],function($,Backbone,Exercises){var CrosswordsLetterView=Backbone.View.extend({initialize:function(options){this.row=options.row,this.column=options.column,this.letter=options.letter,this.fixed=options.fixed,this.content=options.content||this.fixed?this.letter:"",this.oldContent=this.content,this.number=options.number,this.render()},onKeyDown:function(e){switch(e.keyCode){case 37:this.trigger("move",{direction:"left",row:this.row,column:this.column});break;case 38:this.trigger("move",{direction:"up",row:this.row,column:this.column});break;case 39:this.trigger("move",{direction:"right",row:this.row,column:this.column});break;case 40:this.trigger("move",{direction:"down",row:this.row,column:this.column});break;case 8:this.trigger("move",{direction:"previous",row:this.row,column:this.column}),this.changeContent(this.fixed?this.letter:"");break;default:return}e.preventDefault(),e.stopPropagation()},changeContent:function(content){this.$("input").val(content),this.content=content,content!==this.oldContent&&(this.$el.removeClass("xw-letter-ok xw-letter-notok").addClass(this.letter.compareIgnoringCaseAndDiacritics(content)?"xw-letter-ok":"xw-letter-notok"),this.trigger("change",{row:this.row,column:this.column,letter:content,oldContent:this.oldContent}),this.oldContent=content)},onInputChange:function(){var content=this.fixed?this.letter:this.$("input").val();content=content.slice(-1).toLocaleUpperCase(),this.changeContent(content),this.trigger("move",{direction:"next",row:this.row,column:this.column})},onFocus:function(){this.$("input").select(),this.trigger("move",{direction:"reset-direction",row:this.row,column:this.column})},events:{keydown:"onKeyDown",input:"onInputChange",click:"onFocus"},focus:function(){this.$("input").focus()},setWordId:function(id){this.$el.addClass("xwgrid-word-id-"+id)},render:function(){if(this.$el.empty(),this.$el.addClass("xwgrid-letter"),this.$el.addClass("xwgrid-letter-non-blank"),this.$el.addClass("xwgrid-letter-row-"+this.row),this.$el.addClass("xwgrid-letter-column-"+this.column),this.$el.addClass("xwgrid-letter-letter-"+this.letter)," "!==this.number){var $num=$("<span></span>");$num.addClass("xwnumber"),$num.text(this.number),this.$el.append($num)}var $input=$('<input type="text"/>');return this.fixed&&this.$el.addClass("xw-letter-fixed"),this.content&&""!==this.content&&($input.val(this.content),this.$el.addClass(this.content===this.letter?"xw-letter-ok":"xw-letter-notok")),this.$el.append($input),this}}),CrosswordsView=Backbone.View.extend({tagName:"div",className:"xwgrid sans",initialize:function(options){var self=this,words=options.words,letters=[],numbers=[],fixed=[];_.each(words,function(word){letters.push(word.replace(/\d|>/g," ").replace(/\s/g,"").split("")),numbers.push(word.replace(/\s/g,"").replace(/[^\d]/g,"_").split("_")),fixed.push(word.replace(/\d+|\s+/g,"").replace(/[^>]/g,"_").replace(/>_/g,">").split(""))}),self.letters=letters,self.numbers=numbers,self.fixed=fixed,self.state=options.state||[],self.createSolutionMatrix(),self.render()},createSolutionMatrix:function(){var self=this;self.solutions=[];var i,j,cw,letter;j=0;for(var max=self.letters[0].length;max>j;){for(cw=[],i=0;i<=self.letters.length;)letter=self.letters[i]&&self.letters[i][j],letter&&"_"!==letter?cw.push([i,j,letter]):(cw.length>1&&self.solutions.push(cw),cw=[]),i++;j++}for(i=0;i<self.letters.length;){for(cw=[],j=0;j<=self.letters[i].length;)letter=self.letters[i][j],letter&&"_"!==letter?cw.push([i,j,letter]):(cw.length>1&&self.solutions.push(cw),cw=[]),j++;i++}},createBlankBox:function(row,col){var $box=$("<span></span>");return $box.addClass("xwgrid-letter"),$box.addClass("xwgrid-letter-row-"+row),$box.addClass("xwgrid-letter-column-"+col),$box.addClass("xwgrid-letter-blank"),$box},change:function(params){var self=this,r=params.row-1,c=params.column-1,l=params.letter;self.state[r][c]=l,self.trigger("change:state",self.state,self)},render:function(){var self=this;self.views=[],self.$el.html(""),_.each(self.letters,function(row,i){var $row=$("<div></div>");$row.addClass("xwgrid-row"),$row.addClass("xwgrid-row-"+i),self.views[i]=[],self.state[i]=self.state[i]||[],_.each(row,function(letter,j){if("_"===letter)$row.append(self.createBlankBox(i+1,j+1,self.numbers[i][j]));else{var isFixed=">"===self.fixed[i][j];isFixed&&(self.state[i][j]=letter);var state=self.state[i][j]||"",view=new CrosswordsLetterView({row:i+1,column:j+1,letter:letter,fixed:isFixed,content:state,number:self.numbers[i][j]});self.listenTo(view,"move",self.move),self.listenTo(view,"change",self.change),$row.append(view.$el),self.views[i][j]=view}self.$el.append($row)})});for(var i in self.solutions)for(var j in self.solutions[i]){var sol=self.solutions[i][j];self.views[sol[0]][sol[1]].setWordId(i)}return self},getDirectionForStartNode:function(row,col){var self=this,right=self.letters[row][col+1];if(right&&"_"!==right)return self.state[row]&&self.state[row][col]&&self.state[row][col].length>0&&self.state[row+1]&&self.state[row+1][col]&&0===self.state[row+1][col].length?"V":">";var down=self.letters[row+1][col];return down&&"_"!==down?"V":void 0},getNext:function(row,col){var self=this,next={row:row,col:col},antiInfiniteLoop=!1;if("V"===self.direction){if(next.row++,self.letters[next.row]&&self.letters[next.row][next.col]&&"_"!==self.letters[next.row][next.col])return next;for(antiInfiniteLoop=!1;;)if(next.row++,next.row>=self.letters.length&&(next.row=0,next.col++,next.col>self.letters[next.row].length&&(next.col=0,antiInfiniteLoop===!0&&alert("Hey, you need at least one number in the Crosswords puzzle."),antiInfiniteLoop=!0)),self.numbers[next.row]&&self.numbers[next.row][next.col]&&" "!==self.numbers[next.row][next.col])return self.direction=self.getDirectionForStartNode(next.row,next.col),next}else{if(next.col++,self.letters[next.row]&&self.letters[next.row][next.col]&&"_"!==self.letters[next.row][next.col])return next;for(antiInfiniteLoop=!1;;)if(next.col++,next.col>=self.letters[next.row].length&&(next.col=0,next.row++,next.row>=self.letters.length&&(next.row=0,antiInfiniteLoop===!0&&alert("Hey, you need at least one number in the Crosswords puzzle."),antiInfiniteLoop=!0)),self.numbers[next.row]&&self.numbers[next.row][next.col]&&" "!==self.numbers[next.row][next.col])return self.direction=self.getDirectionForStartNode(next.row,next.col),next}},getPrevious:function(row,col){var self=this,prev={row:row,col:col};return"V"===self.direction?(row--,row=Math.max(0,row),self.letters[row][col]&&"_"!==self.letters[row][col]&&(prev.row=row)):(col--,col=Math.max(0,col),self.letters[row][col]&&"_"!==self.letters[row][col]&&(prev.col=col)),prev},getLeft:function(row,col){var self=this,next={row:row,col:col};do if(col--,0>col&&(col=self.letters[row].length-1),self.letters[row][col]&&"_"!==self.letters[row][col]){next.col=col;break}while(col!==next.col);return next},getRight:function(row,col){var self=this,next={row:row,col:col};do if(col++,col>=self.letters[row].length&&(col=0),self.letters[row][col]&&"_"!==self.letters[row][col]){next.col=col;break}while(col!==next.col);return next},getUp:function(row,col){var self=this,next={row:row,col:col};do if(row--,0>row&&(row=self.letters.length-1),self.letters[row][col]&&"_"!==self.letters[row][col]){next.row=row;break}while(row!==next.row);return next},getDown:function(row,col){var self=this,next={row:row,col:col};do if(row++,row>=self.letters.length&&(row=0),self.letters[row][col]&&"_"!==self.letters[row][col]){next.row=row;break}while(row!==next.row);return next},move:function(options){var where,self=this,d=options.direction,r=options.row-1,c=options.column-1;switch(d){case"reset-direction":return void(self.direction=self.getDirectionForStartNode(r,c));case"up":where=self.getUp(r,c);break;case"down":where=self.getDown(r,c);break;case"left":where=self.getLeft(r,c);break;case"right":where=self.getRight(r,c);break;case"previous":where=self.getPrevious(r,c);break;case"next":where=self.getNext(r,c)}(where.row!==r||where.col!==c)&&self.views[where.row][where.col].focus()},score:function(){var i,j,word,row,col,letter,lettersOkInWord,self=this,score=0;for(i in self.solutions){word=self.solutions[i],lettersOkInWord=0;for(j in word)row=word[j][0],col=word[j][1],letter=word[j][2],letter.compareIgnoringCaseAndDiacritics(self.state[row][col])&&lettersOkInWord++,lettersOkInWord===word.length?(score++,self.$(".xwgrid-word-id-"+i).removeClass("xw-word-not-ok").addClass("xw-word-ok")):self.$(".xwgrid-word-id-"+i).removeClass("xw-word-ok").addClass("xw-word-not-ok")}return score=Math.round(100*score/self.solutions.length),self.trigger("change:score",score),score}}),Crosswords=Exercises.Exercise.extend({type:"Crosswords",componentDidMount:function(){var self=this;self.view=new CrosswordsView({words:self.options.words,state:self.get("state"),numbering:self.options.numbering}),self.$el.find(".xwordscontent").html(self.view.render().el),self.listenTo(self.view,"change:state",function(state){self.set("state",state);var score=self._score();self.trigger("change",self),self.trigger("change:score",score)});var l=self.options.words.join(" ").replace(/[^a-zA-Z]/g,"").length;self.irritationLevel=self.options.irritationLevel||5*l},reset:function(){var self=this;self.unset("state"),self.trigger("change",self),self.view.initialize({words:self.options.words,state:self.get("state"),numbering:self.options.numbering})},render:function(){var self=this;if(!self.options.noAutoResize){var resize=function(){var size=Math.floor(self.$el.find(".xwordscontent").width()/1.05/(1+self.options.words[0].replace(/\s|\d/g,"").length));self.$el.find(".xwgrid-letter").width(size+"px").height(size+"px").css("font-size",size/2+"px")};$(window).resize(resize),resize()}self.options.hideNumbers&&self.$el.find(".xwnumber").hide()},score:function(){var score=this.view.score();return score}});return Exercises.Crosswords=Crosswords,Exercises});