define(["jquery","../js/exercise"],function($,Exercises){var CombineSyllables=Exercises.Exercise.extend({type:"CombineSyllables",saveState:function(){this.set("state",this.state),this.trigger("change:state",this.state,this)},forceReflow:function(cb){this.$el[0].offsetWidth=this.$el[0].offsetWidth,setTimeout(cb,0)},componentDidMount:function(){var self=this;self.words=self.options.words||[],self.recall=self.options.recall,void 0===self.recall&&(self.recall=!0),self.autoValidate=self.options.autoValidate,self.bonusScore=self.options.bonusScore,self.wordCount=self.options.wordCount||self.words.length,self.callback=eval("(function(word, valid, already) {"+(self.options.callback||"")+";})").bind(self),self.state=self.get("state")||{},void 0===self.state.syllables&&(self.state.syllables=[]),void 0===self.state.guessedWords&&(self.state.guessedWords=[]);var l=self.$el.find(".item").length,w=self.options.words.length;self.irritationLevel=self.options.irritationLevel||Math.max(l*l+w*w,self.defaultIrritationLevel),self.$el.find('[data-target="combine-syllables.validate"]').click(self.validate.bind(self)),self.$el.find('[data-target="combine-syllables.clearlist"]').click(self.clearList.bind(self));var items=self.$el.find(".item");self.dropspot=self.$el.find(".dropspot"),self.wordlist=self.$el.find(".wordlist"),self.dropspot.css("position","relative"),self.bindEvents(),self.buildArrangedArray(items,function(){self.configureForDrag(items),self.forceReflow(self.render.bind(self))})},configureForDrag:function(el){var self=this;el.on("mousedown",function(e){self.touchId=null,self.mouseDown(e.clientX,e.clientY,$(this))&&e.preventDefault()}),el.on("touchstart",function(e){if(!self.touchId){var touch=e.originalEvent.touches[0],x=touch.pageX-$(window).scrollLeft(),y=touch.pageY-$(window).scrollTop();self.mouseDown(x,y,$(this))&&(e.preventDefault(),self.touchId=touch.identifier)}}),el.on("touchmove",function(e){for(var touches=e.originalEvent.changedTouches,i=0,n=touches.length;n>i;i++){var touch=touches[i];if(touch.identifier===self.touchId){self.mouseMove(touch.pageX-$(window).scrollLeft(),touch.pageY-$(window).scrollTop())&&(e.preventDefault(),e.stopPropagation());break}}}),el.on("touchend touchcancel",function(e){for(var touches=e.originalEvent.changedTouches,i=0,n=touches.length;n>i;i++){var touch=touches[i];if(touch.identifier===self.touchId){self.touchId=null,self.mouseUp()&&e.preventDefault();break}}}),self.msCrapware&&el.each(function(idx,elem){var pointerDown=function(e){if(!self.touchId){var x=e.pageX-$(window).scrollLeft(),y=e.pageY-$(window).scrollTop();self.mouseDown(x,y,$(this))&&(self.touchId=e.pointerId,e.preventDefault(),e.stopPropagation())}};self.msBullshit?elem.addEventListener("MSPointerDown",pointerDown):elem.addEventListener("pointerdown",pointerDown)})},bindEvents:function(){var self=this,elem=document,mouseMove=function(e){self.touchId||self.mouseMove(e.clientX,e.clientY)&&(e.preventDefault(),e.stopPropagation())},mouseUp=function(){self.touchId||self.mouseUp()};if($(elem).on("mousemove",mouseMove),$(elem).on("mouseup",mouseUp),self.msCrapware=!1,self.msBullshit=!0,window.navigator.pointerEnabled?(self.msCrapware=!0,self.msBullshit=!1):window.navigator.msPointerEnabled&&(self.msCrapware=!0),self.msCrapware){var pointerMove=function(e){if(self.touchId===e.pointerId){var x=e.pageX-$(window).scrollLeft(),y=e.pageY-$(window).scrollTop();self.mouseMove(x,y,$(this))&&(e.preventDefault(),e.stopPropagation())}},pointerUp=function(e){self.touchId===e.pointerId&&(self.touchId=null,self.mouseUp()&&(e.preventDefault(),e.stopPropagation()))};self.msBullshit?(elem.addEventListener("MSPointerMove",pointerMove),elem.addEventListener("MSPointerUp",pointerUp),elem.addEventListener("MSPointerCancel",pointerUp)):(elem.addEventListener("pointermove",pointerMove),elem.addEventListener("pointerup",pointerUp),elem.addEventListener("pointercancel",pointerUp))}self.cancelEvents=function(){self.msCrapware&&(self.msBullshit?(elem.removeEventListener("MSPointerMove",pointerMove),elem.removeEventListener("MSPointerUp",pointerUp),elem.removeEventListener("MSPointerCancel",pointerUp)):(elem.removeEventListener("pointermove",pointerMove),elem.removeEventListener("pointerup",pointerUp),elem.removeEventListener("pointercancel",pointerUp))),$(elem).off("mousemove",mouseMove),$(elem).off("mouseup",mouseUp)}},componentWillUnmount:function(){var self=this;self.cancelEvents&&(self.cancelEvents(),delete self.cancelEvents)},buildArrangedItem:function(item){var newEl=item.clone();return newEl.removeClass("used"),newEl.removeClass("dragging"),newEl.css("position","absolute"),newEl.css("margin-top",0),newEl.addClass("animated"),newEl},buildArrangedArray:function(elements,cb){var self=this,items=[];elements.each(function(idx,el){var $el=$(el),syl=$el.data("syl");$el.attr("data-index",idx),items.push({syl:syl,el:$el,used:!1})}),self.items=items;var tillCallback=1;self.arrangedItems=[],_.each(self.state.syllables,function(syl){var i,n;for(i=0,n=items.length;n>i&&(items[i].syl!==syl||items[i].used);i++);if(i===n)throw new Error("You just gave me a nonexistant syllable");tillCallback++;var $el=self.buildArrangedItem(items[i].el);self.dropspot.append($el),self.arrangedItems.push($el),self.configureForDrag($el),$el.css("width",""),$el.css("height",""),self.forceReflow(function(){var width=$el.width(),height=$el.height(),outerWidth=$el.outerWidth(),outerHeight=$el.outerHeight();$el.css("width",width),$el.css("height",height),$el.data("reflowOuterWidth",outerWidth),$el.data("reflowOuterHeight",outerHeight),items[i].used=!0,--tillCallback||cb()})}),--tillCallback||cb()},render:function(){var self=this;_.each(self.items,function(it){it.used?it.el.addClass("used"):it.el.removeClass("used")});var x=0;_.each(self.arrangedItems,function(el){el.css("margin-left",x);var w=el.data("reflowOuterWidth");x+=(void 0===w?el.outerWidth():w)+2}),self.$el.toggleClass("empty",0===self.arrangedItems.length);var wordlistHtml="";_.each(self.state.guessedWords,function(o){wordlistHtml+='<div class="word'+(self.lastWord===o?" last":"")+'">'+o+"</div>"}),self.wordlist.html(wordlistHtml)},positionInWindow:function(div){var pos=div.offset();return pos.top-=$(window).scrollTop()-div.css("margin-top"),pos.left-=$(window).scrollLeft()-div.css("margin-left"),pos},hitTest:function(x,y,div){var pos=div.offset();pos.top-=$(window).scrollTop(),pos.left-=$(window).scrollLeft();var w=div.outerWidth(),h=div.outerHeight();return x>=pos.left&&x<=pos.left+w&&y>=pos.top&&y<=pos.top+h},positionElement:function($el,x,y){for(var vendors=["","-webkit-","-moz-","-ms-","-o-"],i=0,n=vendors.length;n>i;i++)$el.css(vendors[i]+"transform","translate3d("+x+"px, "+y+"px, 0px)")},recallTo:function(from,to,cb){var self=this;from.addClass("animated");var pos=to.offset();pos.top-=$(window).scrollTop(),pos.left-=$(window).scrollLeft(),self.positionElement(from,pos.left,pos.top);var width=to.data("reflowWidth"),height=to.data("reflowHeight");void 0===width&&(width=to.width()),void 0===height&&(height=to.height()),from.css("width",width),from.css("height",height);var oldPos=from.offset();oldPos.top-=$(window).scrollTop(),oldPos.left-=$(window).scrollLeft();var oldWidth=from.width(),oldHeight=from.height();oldPos.top!==pos.top||oldPos.left!==pos.left||oldWidth!==width||oldHeight!==height?from.on("webkitTransitionEnd otransitionend oTransitionEnd msTransitionEnd transitionend",function(){cb.call(self)}):cb.call(self)},mouseDown:function(x,y,$el){var self=this;if(self.currentlyDragged||$el.data("dragged"))return!1;for(var index=-1,i=0,v=self.arrangedItems,n=v.length;n>i;i++)if(v[i].is($el)){index=i;break}var origin=self.items[$el.data("index")];if(-1===index&&origin.used)return!1;self.lastTouchedObject=-2,self.dragStartIndex=self.dragEndIndex=index,self.lastX=x,self.lastY=y,self.$el.removeClass("good"),self.$el.removeClass("bad"),self.$el.removeClass("already-submitted");var clone=$el.clone();self.currentlyDragged=$el;var offset=$el.offset(),width=$el.width(),height=$el.height();return index>=0?(self.placeholder=clone,self.arrangedItems[index]=clone,self.insideDropspot=!0):(origin.el=clone,self.configureForDrag(clone),self.placeholder=self.buildArrangedItem($el),self.placeholder.css("width",width),self.placeholder.css("height",height),self.insideDropspot=!1),$el.removeClass("animated"),$el.css("margin-left",0),$el.css("margin-top",0),$el.addClass("dragging"),self.placeholder.addClass("placeholder"),$el.css("left",0),$el.css("top",0),self.dragX=offset.left-$(window).scrollLeft(),self.dragY=offset.top-$(window).scrollTop(),self.positionElement($el,self.dragX,self.dragY),$el.css("width",width),$el.css("height",height),$el.css("position","fixed"),$el.attr("data-dragged","true"),clone.addClass("dragging-from"),$el.after(clone),!0},mouseUp:function(){var self=this,$el=self.currentlyDragged;if(!$el)return!1;self.currentlyDragged=null;var origin=self.items[$el.data("index")];if(!(self.dragEndIndex<0)){self.dragEndIndex!==self.dragStartIndex&&(self.dragStartIndex>=0?self.state.syllables.splice(self.dragStartIndex,1):origin.used=!0,self.state.syllables.splice(self.dragEndIndex,0,origin.el.data("syl")),self.saveState());var placeholder=self.placeholder;self.placeholder=null,self.configureForDrag(placeholder);var oldWidth=placeholder.width(),oldHeight=placeholder.height();return placeholder.css("width",""),placeholder.css("height",""),placeholder.removeClass("animated"),self.forceReflow(function(){var width=placeholder.width(),height=placeholder.height();placeholder.data("reflowOuterWidth",placeholder.outerWidth()),placeholder.data("reflowOuterHeight",placeholder.outerHeight()),placeholder.data("reflowWidth",width),placeholder.data("reflowHeight",height),placeholder.css("width",oldWidth),placeholder.css("height",oldHeight),self.forceReflow(function(){placeholder.addClass("animated"),placeholder.css("width",width),placeholder.css("height",height),self.render(),self.recallTo($el,placeholder,function(){placeholder.removeClass("placeholder"),placeholder.removeClass("dragging-from"),origin.el.removeClass("dragging-from"),self.forceReflow(function(){$el.remove()})})})}),!0}self.dragStartIndex>=0&&(self.state.syllables.splice(self.dragStartIndex,1),origin.used=!1,self.saveState(),self.render()),origin.el.addClass("recall"),self.recallTo($el,origin.el,function(){origin.el.removeClass("dragging-from"),origin.el.removeClass("recall"),$el.remove()}),this.autoValidate&&this.validate()},mouseMove:function(x,y){var self=this,$el=self.currentlyDragged;if(!$el)return!1;var deltaX=x-self.lastX,deltaY=y-self.lastY;self.lastX=x,self.lastY=y,self.dragX+=deltaX,self.dragY+=deltaY,self.positionElement($el,self.dragX,self.dragY);var inDrop=self.hitTest(x,y,self.dropspot);self.insideDropspot!==inDrop&&(self.insideDropspot=inDrop,inDrop?self.dropspotEntered():self.dropspotLeft());for(var touchedObject=inDrop?-1:-2,touchedIndex=touchedObject,i=0,v=self.arrangedItems,n=v.length;n>i;i++){var elem=v[i];if(!elem.is(self.placeholder)&&self.hitTest(x,y,elem)){touchedObject=elem,touchedIndex=i;break}}if(self.lastTouchedObject!==touchedObject){self.lastTouchedObject=touchedObject;var oldIndex=self.dragEndIndex,newIndex=touchedIndex;oldIndex>=0&&newIndex>=0&&oldIndex!==newIndex&&(self.arrangedItems.splice(oldIndex,1),self.arrangedItems.splice(newIndex,0,self.placeholder),self.dragEndIndex=newIndex,self.render())}return!0},dropspotEntered:function(){var self=this;self.dragEndIndex<0&&(self.dropspot.append(self.placeholder),self.dragEndIndex=self.arrangedItems.length,self.arrangedItems.push(self.placeholder),self.render()),self.dropspot.addClass(-1===self.dragStartIndex?"dragover":"dragover-from")},dropspotLeft:function(){var self=this;self.dragEndIndex>=0&&(self.placeholder.remove(),self.arrangedItems.splice(self.dragEndIndex,1),self.dragEndIndex=-1,self.render()),self.dropspot.addClass(-1===self.dragStartIndex?"dragover":"dragover-from")},setPlaceholder:function(placeholder,pos){!placeholder&&this.placeholder&&this.placeholder.removeClass("placeholder"),placeholder&&setTimeout(function(){placeholder.addClass("placeholder")},0),this.placeholder=placeholder,this.dragEndIndex=placeholder?pos:-1},validate:function(){var self=this,word=self.state.syllables.join(""),valid=_.contains(self.words,word),alreadyMatched=_.contains(self.state.guessedWords,word);valid&&!alreadyMatched&&(self.state.guessedWords.push(word),self.recall&&(self.state.syllables=[],_.each(self.arrangedItems,function(el){el.removeClass("animated");var offset=el.offset(),width=el.width(),height=el.height(),x=offset.left-$(window).scrollLeft(),y=offset.top-$(window).scrollTop();el.css("left",0),el.css("top",0),el.css("margin-left",0),el.css("margin-top",0),el.css("width",width),el.css("height",height),el.css("position","fixed"),self.positionElement(el,x,y);var origin=self.items[el.data("index")];origin.el.addClass("recall"),origin.used=!1,self.forceReflow(function(){self.recallTo(el,origin.el,function(){el.remove(),origin.el.removeClass("recall")})})}),self.arrangedItems.length=0),self.saveState()),valid&&(self.lastWord=word),self.$el.removeClass("good"),self.$el.removeClass("bad"),self.$el.removeClass("already-submitted"),self.forceReflow(function(){self.autoValidate||valid||self.$el.addClass("bad"),valid&&(alreadyMatched?self.autoValidate||self.$el.addClass("already-submitted"):self.$el.addClass("good")),self.render()}),(!self.autoValidate||valid)&&self.callback(word,valid,alreadyMatched)},clearList:function(){this.state.guessedWords.length=0,this.saveState()},score:function(){var score=this.state.guessedWords.length/this.wordCount;return!score.bonusPoints&&score>1&&(score=1),Math.round(100*score)}});return Exercises.CombineSyllables=CombineSyllables,Exercises});