define(["jquery","underscore","backbone","app","../js/exercises"],function($,_,Backbone,App,Exercises){var Exercise=Backbone.Model.extend({type:"Exercise",isMounted:!1,defaultIrritationLevel:15,_registerEventHandlers:function(){var self=this;self.on("change",Exercises.store.save,this),self.on("change:state",self._score),self.on("change:state",self._render),self.on("change:score",self._renderScoreBoxes),self.on("change:state",function(target,state){window.App.trigger("exercise:state:changed",state,self)},self),self.on("children_ready",function(){self._score(),self._renderScoreBoxes();var irritationLevel=0;_.each(self.children,function(child){irritationLevel+=1.2*child.irritationLevel}),self.irritationLevel+=Math.round(irritationLevel),self.childrenReady=!0,App.trigger("exercise:irritation:up",0,this),"function"==typeof self.onChildrenReady&&self.onChildrenReady()}),window.App.on("exercise:score:invalidate",function(exerciseName){self.name===exerciseName&&(self.set("score",null),self._score())}),self._onScroll=function(){void 0!==self.scrollTimeoutId&&clearTimeout(self.scrollTimeoutId),self.scrollTimeoutId=setTimeout(function(){self.scrollTimeoutId=void 0,self._onScrollEnd()},2e3)},self.scrollView=$("#scrollview"),self.scrollView.length||(self.scrollView=$(window)),self.scrollView.on("scroll",self._onScroll),window.App.book.once("destroy-chapter",self._componentWillUnmount.bind(self))},_onChildChangedState:function(state,exercise){"function"==typeof this.onChildChangedState&&this.onChildChangedState(state,exercise)},_onChildChangedScore:function(state,exercise){"function"==typeof this.onChildChangedScore&&this.onChildChangedScore(state,exercise),this._score(),this._renderScoreBoxes()},_prepareScoreBoxes:function(){var self=this,$progressBox=self.$el.find(".progress-box"),$otherBoxes=self.$el.find(".is-done-box, .score-box");$otherBoxes.dblclick(function(){self.clearState(),window.location.reload()}),self.options.ignoreScore?($progressBox.remove(),$otherBoxes.remove()):($progressBox.each(function(index){if(!$progressBox.eq(index).find(".progress-bar").length){var $progressBar=$('<div class="progress-bar progress-bar-success" id="pb-'+Math.floor(1e9*Math.random())+"-"+index+'" style="width: 50%"></div>');$progressBox.eq(index).append($progressBar)}}),$otherBoxes.each(function(i){var boxie=$otherBoxes.eq(i);boxie.attr("id")||boxie.attr("id","ebox-"+Math.floor(1e9*Math.random()))}),self.get("score")>=100&&(self.wasDoneAlready=!0))},_registerClassroomEventsListener:function(){"function"==typeof this.onRemoteChanges&&this.listenTo(App,"classroom:recv:ex_"+this.id+":change",function(msg){var wg=window.App.workGroup;wg&&msg.group===wg&&this.onRemoteChanges(msg)})},initialize:function(id,optionsJSON){var self=this;this.id=id,this.options={},"string"==typeof optionsJSON&&(self.options=JSON.parse(optionsJSON)),self.children=[],self.name=self.options.name||self.id,Exercises.store.fetch(this),self.set("name",self.options.name||"ex_"+self.id),self.set("type",self.type),"function"==typeof self.componentDidInitialize&&self.componentDidInitialize(),self.irritationLevel=self.options.irritationLevel||self.defaultIrritationLevel,self._registerEventHandlers(),self._registerClassroomEventsListener(),$(function(){self.isMounted=!0,self.$el=$("#ex_"+self.id),self.$el.addClass("exercise"),self.options.name&&self.$el.addClass(self.options.name),self.$el.addClass("type-"+self.type),"function"==typeof self.componentDidMount&&self.componentDidMount(),window.App.trigger("exercise:mounted",self),self._prepareScoreBoxes(),self._render(),self._onScrollEnd()}),window.App.trigger("exercise:initialized")},_render:function(){if(this.isMounted){var self=this;"function"==typeof self.componentWillUpdate&&self.componentWillUpdate(),"function"==typeof self.render&&self.render(),"function"==typeof self.componentDidUpdate&&self.componentDidUpdate(),window.App.trigger("exercise:rendered",self)}},value:function(){return this.get("state")},clearState:function(){var self=this;self.set("state",null),_.each(self.children,function(child){child.clearState()})},_score:function(){if(this.options.ignoreScore)return 0/0;var selfScore;"function"==typeof this.score&&(selfScore=this.score());var score=selfScore||0;if(!this.options.ignoreKidsScore&&this.children.length>0){var s=0,n=0;_.each(this.children,function(child){child.options.ignoreScore||(s+=child.get("score"),n++)}),score=Math.round(void 0!==selfScore?1*(s+selfScore)/(n+1):1*s/n)}var oldScore=this.get("score");return score!==oldScore?(this.set("score",score),window.App.trigger("exercise:score:changed",score,this),oldScore>score?window.App.trigger("exercise:score:decrease",score,this):window.App.trigger("exercise:score:increase",score,this),score>=100&&(this.wasDoneAlready?window.App.trigger("exercise:done",this):(window.App.trigger("exercise:first-time-done",this),this.wasDoneAlready=!0))):window.App.trigger("exercise:score:same",score,this),this.set("score",score),score},_renderScoreBoxes:function(){var self=this,score=this.get("score"),myOwn=function(className){var $all=self.$el.find(className),$notMine=self.$el.find(".exercise "+className),notMineIds=[];$notMine.each(function(i){notMineIds.push($notMine.eq(i).attr("id"))});var $mine=$all.filter(function(i){var pbox=$all.eq(i),id=pbox.attr("id");return!_.contains(notMineIds,id)});return $mine};myOwn(".progress-box .progress-bar").width(score+"%"),myOwn(".is-done-box").html(score>=100?'<i class="fa fa-check done"></i>':'<i class="fa fa-ellipsis-h not-done"></i>'),self.$el.removeClass("done not-done").addClass(score>=100?"done":"not-done"),myOwn(".score-box").text(score+"%")},present:function(){var self=this;self.$el.addClass("presented"),self.$el.one("webkitAnimationEnd oanimationend msAnimationEnd animationend",function(){self.$el.removeClass("presented")})},_onScrollEnd:function(){if(this.isMounted&&!this.isPresented){var vpY1=this.scrollView.scrollTop(),vpY2=this.scrollView.height()+vpY1,exY1=this.$el.offset().top,scrollViewOff=this.scrollView.offset();scrollViewOff&&(exY1-=scrollViewOff.top-vpY1);var exY2=this.$el.outerHeight()+exY1;(exY1>=vpY1&&vpY2>=exY1||exY2>=vpY1&&vpY2>=exY2||vpY1>=exY1&&exY2>=vpY1)&&(this.isPresented=!0,this._unbindScrollEvent(),this.present())}},_unbindScrollEvent:function(){var self=this;self.scrollView&&(self.scrollView.off("scroll",self._onScroll),self.scrollView=null),void 0!==self.scrollTimeoutId&&(clearTimeout(self.scrollTimeoutId),self.scrollTimeoutId=void 0)},_componentWillUnmount:function(){var self=this;self._unbindScrollEvent(),"function"==typeof self.componentWillUnmount&&self.componentWillUnmount(),self.stopListening()}});return Exercises.Exercise=Exercise,Exercises});