define(["jquery","../js/exercise"],function($,Exercises){var generateMultiplyToAdditionPattern=function(a,b){for(var i=0,r="^\\s*";a-1>i;)r=r+b+"\\s*\\+\\s*",i++;if(r=r+b+"\\s*$",a===b)return r;for(r+="|^\\s*",i=0;b-1>i;)r=r+a+"\\s*\\+\\s*",i++;return r=r+a+"\\s*$"},generateReflexiveMultiplyPattern=function(a,b){var r="^\\s*"+a+"\\s*[x|X|*]\\s*"+b+"\\s*$";return a===b?r:r+="|^\\s*"+b+"\\s*[x|X|*]\\s*"+a+"\\s*$"},allowSpacesOn=function(expression){return"string"==typeof expression?"^\\s*"+expression.replace(/\s+/g,"").replace(/([\/\+\-\(\)])/g,"\\$1").replace(/(\w)(\W+)/g,"$1\\s*$2\\s*")+"\\s*$":void 0},Textline=Exercises.Exercise.extend({type:"Textline",defaultIrritationLevel:25,componentDidMount:function(){var self=this;self.inputType=self.options.type||"text",self.max=self.options.max,self.placeholder=self.options.placeholder||"",self.title=self.options.title||"",self.trim=self.options.trim||!1,self.maxlength=self.options.max||"",self.size=self.options.size||self.options.max&&Math.min(50,self.options.max)||"",self.rows=self.options.rows||4,self.pattern=self.options.pattern||"*";var c=parseInt(self.maxlength||self.size);"numeric"===self.options.rows&&(c*=2*self.options.rows),isNaN(c)||(self.irritationLevel=self.options.irritationLevel||c*c+self.defaultIrritationLevel),self.$input=self.$el.find(".input"),0===self.$input.length&&(self.$input=self.$el),"multiply-to-addition"===self.inputType&&(self.inputType="numeric",self.options.pattern=self.options.regexp=generateMultiplyToAdditionPattern(self.options.a||1,self.options.b||1)),"reflexive-multiply"===self.inputType&&(self.inputType="numeric",self.options.pattern=self.options.regexp=generateReflexiveMultiplyPattern(self.options.a||1,self.options.b||1)),self.options.allowWhitespace&&(self.options.regexp=allowSpacesOn(self.options.regexp),self.options.pattern=allowSpacesOn(self.options.pattern)),self.regexp=new RegExp(self.options.regexp||".+",self.options.regexpFlags||""),self.$input.append("multiline"===self.inputType?$('<textarea class="input-box" type="'+self.inputType+'" placeholder="'+self.placeholder+'" title="'+self.title+'" pattern="'+self.pattern+'" cols="'+self.size+'" rows="'+self.rows+'" maxlength="'+self.maxlength+'"></textarea>'):$('<input class="input-box" type="'+self.inputType+'" placeholder="'+self.placeholder+'" pattern="'+self.pattern+'" size="'+self.size+'" title="'+self.title+'" maxlength="'+self.maxlength+'"/>'));var $box=self.$input.find(".input-box"),onInputChange=function(e){var state=e.target.value;state!==self.get("state")&&self.set("state",state)};$box.keyup(onInputChange),$box.scroll(onInputChange),$box.click(onInputChange),$box.blur(onInputChange)},render:function(){var self=this,state=self.get("state")||self.options.initialText||"",currentText=self.$input.find(".input-box").val();state!==currentText&&self.$input.find(".input-box").val(state);var matches=state.match(self.regexp),i=0,l=matches&&matches.length;for(self.options.disabled&&self.$input.find(".input-box").prop("disabled",!0);l>i;)self.$el.find("[class^=match"+i+"]").text(matches[i]),i++;if(self.maxlength){var remaining=self.maxlength-state.length,$remaining=self.$el.find(".remaining");$remaining.text(remaining),$remaining.removeClass("remaining-alert"),1*remaining/self.maxlength<.2&&$remaining.addClass("remaining-alert")}},score:function(){var self=this,state=self.get("state")||"",matches=state.match(self.regexp);return matches&&matches.length>0?100:0}});return Exercises.Textline=Textline,Exercises});