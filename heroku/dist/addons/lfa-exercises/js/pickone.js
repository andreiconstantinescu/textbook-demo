define(["app","../js/exercise"],function(App,Exercises){var PickOne=Exercises.Exercise.extend({type:"PickOne",componentDidMount:function(){var i,howMany,self=this;if(self.answer=self.options.answer||1,self.choices=self.options.choices||[],self.placement=self.options.placement||"right",self.options.placeholder=self.options.placeholder||"..",0===self.choices.length)for(howMany=self.answer+4*Math.random(),i=1;howMany>=i;i++)self.choices.push(""+i);for(i=0,howMany=self.choices.length;howMany>i;i++)self.choices[i]=self.choices[i].toString();self.on("change:state",function(){self.changingRemotely||App.trigger("classroom:broadcast",{action:"ex_"+self.id+":change",state:self.get("state")})}),self.irritationLevel=self.options.irritationLevel||Math.max(3,Math.round(self.choices.length/2)),self.$btnTrigger=self.$el.find(".trigger"),0===self.$btnTrigger.length&&(self.$btnTrigger=$('<button type="button" class="btn btn-default trigger"></button>'),self.$el.append(self.$btnTrigger)),self.choiceContainer=self.$el.find(".choices-container");var onClick=function(e){var state,$target=$(e.target);do{if(state=$target.data("value"))break;$target=$target.parent()}while($target.length>0);self.set("state",state),self.$btnTrigger.popover("hide")};self.popover=self.$btnTrigger.popover({html:!0,trigger:"manual",placement:this.placement,content:function(){self.choiceContainer.css("width",.5*$("article").width()),self.choiceContainer.css("display","block"),self.choiceContainer.empty();var $choices=$('<div class="choices"></div>');self.choiceContainer.append($choices);for(var $btnGroup=null,height=0,width=0,state=self.get("state")-1,i=0;i<self.choices.length;i++){var $button=$('<button type="button" class="btn btn-default" data-value="'+(i+1)+'">'+self.choices[i]+"</button>");if(!self.options.noClassChange&&state===i){var newClass=self.options.ignoreAnswer||i===self.answer-1?"btn-success":"btn-danger";$button.addClass(newClass)}var hadBtnGroup=!0;$btnGroup||($btnGroup=$('<div class="btn-group"></div>'),$choices.append($btnGroup),hadBtnGroup=!1),$btnGroup.append($button);var newHeight=$choices.height();if(height!==newHeight&&hadBtnGroup)$button.remove(),$btnGroup=null,i--;else{var newWidth=$btnGroup.width();newWidth>width&&(width=newWidth)}height=newHeight}return self.choiceContainer.css("display",""),$choices.css("width",width+2),$choices.css("height",height+2),$choices[0].outerHTML}}),self.popover.on("shown.bs.popover",function(){var buttons=$("#ex_"+self.id+" .popover button");buttons.each(function(id,button){$(button).click(onClick)})});var onClickInside=function(){self.$btnTrigger.popover("show")},onClickOutside=function(e){var pop=$("#ex_"+self.id+" .popover");pop.is(e.target)||pop.has(e.target).length||(self.$btnTrigger.popover("hide"),e.preventDefault(),e.stopPropagation())};self.$btnTrigger.on("click",onClickInside),self.popover.on("show.bs.popover",function(){$(document).on("mouseup",onClickOutside),self.$btnTrigger.off("click",onClickInside)}),self.popover.on("hide.bs.popover",function(){$(document).off("mouseup",onClickOutside)}),self.popover.on("hidden.bs.popover",function(){self.$btnTrigger.on("click",onClickInside)})},onRemoteChanges:function(msg){var self=this;self.changingRemotely=!0,self.set("state",parseInt(msg.state)),self.changingRemotely=!1;var newValue=self.choices[parseInt(msg.state)-1];newValue||(self.changingRemotely=!0,self.set("state",void 0),self.changingRemotely=!1,newValue=App.T.translate("yesNoNothing"));var notification=App.T.translate("yesNoChangedNoDescription",[msg.from.name||msg.from.id,newValue]);App.trigger("notify",notification)},render:function(){var state=parseInt(this.get("state"))-1;this.choices[state]?(this.$btnTrigger.html(this.choices[state]),this.options.noClassChange||this.$btnTrigger.removeClass("btn-success btn-danger").addClass(this.options.ignoreAnswer||this.get("state")===this.answer?"btn-success":"btn-danger")):this.$btnTrigger.html(this.options.placeholder)},score:function(){return 100*(this.options.ignoreAnswer||this.get("state")===this.answer)}});return Exercises.PickOne=PickOne,Exercises});