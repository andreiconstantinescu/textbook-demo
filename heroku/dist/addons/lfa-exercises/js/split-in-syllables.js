define(["jquery","underscore","backbone","../js/exercise"],function($,_,Backbone,Exercises){var SeparatorView=Backbone.View.extend({tagName:"span",className:"split-in-syllables-separator",initialize:function(options){this.separator=options.separator,this.isSelected=options.selected,this.render()},onClick:function(){var self=this;self.$el.data("margin",self.$el.data("margin")?"yes":void 0),self.$el.toggleClass("split-in-syllables-separator-selected"),self.isSelected=!self.isSelected,self.trigger("change")},events:{click:"onClick"},render:function(){var self=this;self.$el.empty();var $separator=$("<span></span>");return $separator.html(self.separator),self.$el.append($separator),self.isSelected&&self.$el.addClass("split-in-syllables-separator-selected"),self}}),SplitInSyllablesView=Backbone.View.extend({tagName:"div",className:"split-in-syllables-container",initialize:function(options){var self=this;self.word=options.word,self.state=options.state,self.separator=options.separator,self.letters=self.word.replace(/\^\^/g,"||").split("||"),self.render(),self.solution=[],_.each(self.word.replace(/[^\^\^|^||]/g,""),function(elem,index){index%2&&"^"===elem&&self.solution.push((index-1)/2)})},onChange:function(){var self=this,$result=self.$(".split-in-syllables-separator"),selected=[];$result.each(function(index){$result.eq(index).hasClass("split-in-syllables-separator-selected")&&selected.push(index)}),self.trigger("SelectionUpdated",{selection:selected,solution:self.solution})},getValue:function(){var self=this,items=self.$(".split-in-syllables-letter, .split-in-syllables-separator-selected"),result="";return _.each(items,function(item,index){result+=items.eq(index).html()}),result},render:function(){var self=this;return self.$el.empty(),_.each(self.letters,function(letter,index){var $letter=$("<span></span>");if($letter.addClass("split-in-syllables-letter"),$letter.html(letter),self.$el.append($letter),index<self.letters.length-1){var isSelected=_.indexOf(self.state,index)>=0,separator=new SeparatorView({separator:self.separator,selected:isSelected});self.listenTo(separator,"change",self.onChange),self.$el.append(separator.$el)}}),self}}),SplitInSyllables=Exercises.Exercise.extend({type:"SplitInSyllables",newButton:function(){return $('<button class="btn btn-primary btn-lg" data-toggle="modal" data-target="#ex_'+this.id+'_modal">'+(this.options.triggerLabelText||"Show")+"</button>")},addTriggerClasses:function(){var self=this;this.$trigger.each(function(index){self.$trigger.eq(index).attr("data-toggle","modal").attr("data-target","#ex_"+self.id+"_modal")})},onChangeSelection:function(params){var selection=params.selection,solution=params.solution,common=_.intersection(selection,solution),different=_.difference(selection,solution);this.set("state",selection);var score=(common.length-different.length)/solution.length*100;score=Math.round(Math.max(0,score)),this.set("score",score)},componentDidMount:function(){var self=this;if(self.$preview=self.$el.find(".preview"),self.$result=self.$el.find(".result"),self.$trigger=self.$el.find(".trigger"),self.$body=self.$el.find(".split-in-syllables-body"),0===self.$body.length&&(self.$body=$("<span></span>"),self.$body.addClass("split-in-syllables-body"),self.options.isModal?self.$el.find(".modal-body").append(self.$body):self.$el.append(self.$body)),self.view=new SplitInSyllablesView({word:self.options.word,separator:self.options.separator,state:self.get("state")}),self.listenTo(self.view,"SelectionUpdated",self.onChangeSelection),self.$body.empty().append(self.view.$el),self.view.onChange(),self.irritationLevel=self.options.irritationLevel||Math.round(3.2*self.options.word.replace(/\^\^/g,"||").split("||").length),self.options.isModal){self.$el.append(self.$preview.detach());var $header=self.$el.find(".full-screen-header");$header.length&&self.$el.find(".modal-header span.replaceable").empty().append($header.detach()),self.$trigger.length>0?self.addTriggerClasses():(self.$trigger=self.newButton(),self.$el.append(self.$trigger)),self.$el.find(".modal").on("show.bs.modal",self.present.bind(self))}},present:function(){var self=this;self.isPresented=!0,self.$el.find(".split-in-syllables-separator").each(function(index,sep){var $sep=$(sep);$sep.removeClass("updownshake"),setTimeout(function(){$sep.addClass("updownshake")},300*(index+1)*Math.random())})},render:function(){this.$result.html(this.view.getValue())},score:function(){return this.get("score")}});return Exercises.SplitInSyllables=SplitInSyllables,Exercises});